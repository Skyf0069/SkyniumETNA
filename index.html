<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skynium ETNA</title>

    <!-- SDK Auth0 -->
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"></script>
    
    <!-- Font Awesome (pour les icônes Jira, Confluence, etc.) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Favicon (on garde la configuration complète) -->
    <link rel="icon" type="image/png" href="/ressources/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/ressources/favicon/favicon.svg" />
    <link rel="shortcut icon" href="/ressources/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/ressources/favicon/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Skynium" />
    <link rel="manifest" href="/ressources/favicon/site.webmanifest" />
    <meta name="msapplication-TileColor" content="#1d0469"> 
    <meta name="theme-color" content="#ffffff">

    <style>
        /* ======================================= */
        /* POLICES ET STYLE DE BASE
        /* ======================================= */
        :root {
            --primary: #1D0469;
            --secondary: #FA5DFF;
            --tertiary: #FF8A3F;
            --dark-bg: #333333;
            --white: #FFFFFF;
            --light-grey: #f0f0f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: var(--white);
            /* Le fond diagonal de la capture d'écran */
            background: linear-gradient(110deg, var(--dark-bg) 55%, var(--secondary) 80%, var(--tertiary) 100%);
            min-height: 100vh;
        }

        .hidden {
            display: none !important;
        }

        /* ======================================= */
        /* ÉTATS DE CONNEXION (LOADING / LOGGED OUT)
        /* ======================================= */
        .auth-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            background: var(--dark-bg); /* Fond uni pour l'écran de login */
        }

        .auth-box {
            background: var(--white);
            color: var(--dark-bg);
            padding: 3rem 4rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .auth-box h1 {
            color: var(--primary);
            margin-top: 0;
        }

        #login-button {
            background-color: var(--secondary);
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        #login-button:hover {
            filter: brightness(110%);
        }
        
        .spinner {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ======================================= */
        /* ÉTAT CONNECTÉ (LE HUB ETNA)
        /* ======================================= */
        .page-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 2rem 5%;
        }

        /* --- Header --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .header-logo {
            display: flex;
            align-items: center;
        }

        .header-logo img {
            height: 40px; /* Ajuste la taille de ton logo */
            margin-right: 15px;
        }

        .header-logo span {
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* --- Ticker / Bandeau --- */
        .ticker-section {
            background: var(--white);
            color: var(--dark-bg);
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin: 2.5rem 0;
            padding: 1.5rem 0;
            overflow: hidden; /* Cache le texte qui dépasse */
            width: 100%;
        }

        .ticker-content {
            display: inline-block; /* Permet à l'animation de fonctionner */
            white-space: nowrap; /* Empêche le retour à la ligne */
            padding-left: 100%; /* Commence en dehors de l'écran */
            animation: ticker-slide 30s linear infinite;
        }

        .ticker-content b {
            color: var(--primary);
            margin-right: 3rem;
        }

        .ticker-content span {
            margin-right: 3rem;
        }

        @keyframes ticker-slide {
            0% { transform: translateX(0%); }
            100% { transform: translateX(-150%); } /* Ajuste la distance de défilement */
        }

        /* --- Contenu Principal (Sites) --- */
        main {
            flex-grow: 1;
            width: 100%;
            display: flex;
        }
        
        /* La partie gauche avec les sites (sur le fond sombre) */
        .sites-panel {
            flex-basis: 55%;
            padding-right: 2rem;
        }

        .sites-panel h1 {
            font-size: 5rem;
            font-weight: 800;
            margin-top: 0;
            margin-bottom: 2.5rem;
        }

        .sites-grid {
            display: grid;
            /* Crée 3 colonnes, mais s'adapte en dessous */
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .site-button {
            position: relative;
            background: var(--light-grey);
            color: var(--dark-bg);
            padding: 1.5rem;
            border-radius: 12px;
            text-decoration: none;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .site-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .site-button-logo {
            position: absolute;
            top: -12px;
            right: -12px;
            background: var(--white);
            border-radius: 50%;
            padding: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .site-button-logo img {
            height: 25px;
            width: 25px;
            display: block;
        }
        
        .site-button i.fa-arrow-right {
             transition: transform 0.3s ease;
        }
        .site-button:hover i.fa-arrow-right {
            transform: translateX(5px);
        }
        
        /* La partie droite (sur le fond gradient) */
        .welcome-panel {
            flex-basis: 45%;
            padding-left: 2rem;
            padding-top: 1rem;
        }
        .welcome-panel h2 {
            font-size: 2rem;
            margin-top: 0;
        }
        .welcome-panel p {
            font-size: 1.1rem;
            line-height: 1.7;
        }

        #logout-button {
            background: none;
            border: 2px solid var(--white);
            color: var(--white);
            font-size: 1rem;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.3s ease;
        }
        #logout-button:hover {
            background: var(--white);
            color: var(--dark-bg);
        }

        /* --- Footer --- */
        footer {
            width: 100%;
            text-align: center;
            padding: 2rem 0 1rem 0;
            font-size: 0.9rem;
            opacity: 0.7;
            flex-shrink: 0;
        }

        /* ======================================= */
        /* RESPONSIVE DESIGN
        /* ======================================= */
        @media (max-width: 900px) {
            body {
                /* Sur mobile, on simplifie le fond */
                background: var(--dark-bg);
            }
            .page-container {
                padding: 1rem 5%;
            }
            main {
                flex-direction: column; /* Empile les colonnes */
            }
            .sites-panel {
                flex-basis: auto;
                padding-right: 0;
            }
            .welcome-panel {
                flex-basis: auto;
                padding-left: 0;
                margin-top: 3rem;
            }
            .sites-panel h1 {
                font-size: 3.5rem;
                margin-bottom: 2rem;
            }
            .header-logo span {
                display: none; /* Cache le texte du header sur petit écran */
            }
            .ticker-section {
                margin: 1.5rem 0;
            }
        }

    </style>
</head>
<body>

    <!-- =======================
         ÉTAT DE CHARGEMENT
         S'affiche en premier.
    ======================== -->
    <div id="loading-state" class="auth-container">
        <div class="auth-box">
            <i class="fas fa-spinner spinner"></i>
            <p>Vérification de la session...</p>
        </div>
    </div>

    <!-- =======================
         ÉTAT DÉCONNECTÉ
         S'affiche si l'utilisateur n'est pas connecté.
    ======================== -->
    <div id="logged-out-state" class="auth-container hidden">
        <div class="auth-box">
            <h1>Accès Administrateur</h1>
            <p>Veuillez vous connecter pour accéder à l'ETNA.</p>
            <button id="login-button">
                <i class="fas fa-sign-in-alt"></i> Connexion via SSO
            </button>
        </div>
    </div>

    <!-- ==============================================
         ÉTAT CONNECTÉ (LE HUB ETNA)
         S'affiche SEULEMENT si l'utilisateur est connecté.
    =============================================== -->
    <div id="logged-in-state" class="page-container hidden">

        <!-- --- Header --- -->
        <header>
            <div class="header-logo">
                <!-- Remplace par ton logo -->
                <img src="ressources/logo.png" alt="Logo Skynium">
                <span>Skynium ETNA, (Espace de Travail Numérique pour les membres de l'Administration)</span>
            </div>
        </header>

        <!-- --- Ticker / Bandeau --- -->
        <section class="ticker-section">
            <div class="ticker-content">
                <b>Bienvenue sur Skynium ETNA, la plateforme des administrateurs.</b>
                <span>Espace de Travail Numérique pour les membres de l'Administration</span>
                <span>Prochaine maintenance prévue le 30/11</span>
                <span>Skynium RECONNECT</span>
                <span>Réseau d’Entraide pour la CONnexion, l’Éducation et les Compétences en Technologie</span>
                <span>La technologie est notre avenir, utilisons-là avec soin.</span>
                <b>Bienvenue sur Skynium ETNA, la plateforme des administrateurs.</b>
                <span>Espace de Travail Numérique pour les membres de l'Administration</span>
            </div>
        </section>

        <!-- --- Contenu Principal (Sites) --- -->
        <main>
            <!-- Colonne de Gauche -->
            <section class="sites-panel">
                <h1>Sites</h1>
                <div class="sites-grid">
                    
                    <!-- Bouton 1 -->
                    <a href="https://skynium.fr" class="site-button">
                        <span>Skynium</span>
                        <i class="fas fa-arrow-right"></i>
                        <div class="site-button-logo">
                            <img src="ressources/logo.png" alt="Logo Skynium">
                        </div>
                    </a>

                    <!-- Bouton 2 -->
                    <a href="https://ksuite.skynium-ksuite.fr/" class="site-button">
                        <span>Skynium kSuite</span>
                        <i class="fas fa-arrow-right"></i>
                        <div class="site-button-logo">
                           <img src="https://cdn.jsdelivr.net/gh/homarr-labs/dashboard-icons/svg/ksuite.svg" alt="Logo kSuite">
                        </div>
                    </a>
                    
                    <!-- Bouton 5 -->
                    <a href="https://e-reservation.skynium.fr" class="site-button">
                        <span>E-Reservation</span>
                        <i class="fas fa-arrow-right"></i>
                        <div class="site-button-logo">
                            <img src="https://placehold.co/40x40/ffffff/1D0469?text=E" alt="Logo E-Resa">
                        </div>
                    </a>
                    
                    <!-- Bouton 6 -->
                    <a href="https://abovetheskyproductions.skynium.fr" class="site-button">
                        <span>Above The Sky</span>
                        <i class="fas fa-arrow-right"></i>
                        <div class="site-button-logo">
                            <img src="https://placehold.co/40x40/ffffff/1D0469?text=A" alt="Logo ATS">
                        </div>
                    </a>

                    <a href="https://my.skynium.fr" class="site-button">
                        <span>mySkynium</span>
                        <i class="fas fa-arrow-right"></i>
                        <div class="site-button-logo">
                            <img src="ressources/logo.png" alt="Logo ATS">
                        </div>
                    </a>

                    <a href="https://iris.skynium.fr" class="site-button">
                        <span>Skynium IRIS</span>
                        <i class="fas fa-arrow-right"></i>
                        <div class="site-button-logo">
                            <img src="ressources/logo.png" alt="Logo ATS">
                        </div>
                    </a>

                </div>
            </section>

            <!-- Colonne de Droite (vide sur la capture, mais utile) -->
            <section class="welcome-panel">
                <h2>Bonjour, <span id="user-name">Utilisateur</span> !</h2>
                <p>Bienvenue sur votre espace de travail. Vous trouverez ici tous les accès rapides à vos outils d'administration.</p>
                <button id="logout-button"><i class="fas fa-sign-out-alt"></i> Se déconnecter</button>
            </section>

        </main>

        <!-- --- Footer --- -->
        <footer>
            Skynium® et toutes ses marques, tous droits réservés, 2019 - 2026
        </footer>
    </div>


    <!-- =======================
         LE JAVASCRIPT SSO
         Gère le blocage de la page
    ======================== -->
    <script>
        // Déclaration du client Auth0
        let auth0Client = null;

        // Configuration (REMPLIS CECI AVEC TES INFOS AUTH0)
        const authConfig = {
            // Utilise ton "Custom Domain" pour le service
            domain: "auth.skynium.fr", 
            
            // !! REMPLIS CECI !! Ton Client ID (de ton app SPA dans Auth0)
            clientId: "usnKSbJvl7YPVg8XAfqwZGsCYrLqMo6y", 
            
            // L'URL de ce Hub (l'application)
            redirectUri: "https://etna.skynium.fr/" 
        };

        // Fonction principale au chargement de la page
        document.addEventListener("DOMContentLoaded", async () => {
            
            // 1. Initialiser le client
            try {
                auth0Client = await auth0.createAuth0Client({
                    domain: authConfig.domain,
                    clientId: authConfig.clientId,
                    authorizationParams: {
                        redirect_uri: authConfig.redirectUri
                    }
                });
            } catch (e) {
                console.error("Erreur d'initialisation Auth0", e);
                // Si Auth0 ne se charge pas, on montre l'écran de déconnexion
                document.getElementById("loading-state").classList.add("hidden");
                document.getElementById("logged-out-state").classList.remove("hidden");
                return;
            }

            // 2. Gérer le retour de redirection après connexion
            if (window.location.search.includes("code=") && window.location.search.includes("state=")) {
                try {
                    await auth0Client.handleRedirectCallback();
                } catch (e) {
                    console.error("Erreur HandleRedirectCallback", e);
                }
                
                // Nettoyer l'URL
                window.history.replaceState({}, document.title, "/");
            }

            // 3. Mettre à jour l'interface utilisateur
            await updateUI();

            // 4. Lier les boutons
            document.getElementById("login-button").addEventListener("click", login);
            document.getElementById("logout-button").addEventListener("click", logout);
        });

        // Fonction de mise à jour de l'UI
        const updateUI = async () => {
            const loadingEl = document.getElementById("loading-state");
            const loggedOutEl = document.getElementById("logged-out-state");
            const loggedInEl = document.getElementById("logged-in-state");

            try {
                // C'est ici que la magie du SSO opère
                const isAuthenticated = await auth0Client.isAuthenticated();

                if (isAuthenticated) {
                    // SI CONNECTÉ
                    const userProfile = await auth0Client.getUser();
                    
                    // Personnalise l'accueil
                    document.getElementById("user-name").innerText = userProfile.name || userProfile.email;
                    
                    // Affiche le HUB ETNA
                    loggedInEl.classList.remove("hidden");
                
                } else {
                    // SI DÉCONNECTÉ
                    // Affiche le bouton de connexion
                    loggedOutEl.classList.remove("hidden");
                }

            } catch (e) {
                console.error("Erreur UpdateUI", e);
                loggedOutEl.classList.remove("hidden");
            } finally {
                // Cache l'écran de chargement dans tous les cas
                loadingEl.classList.add("hidden");
            }
        };

        // Fonction de connexion
        const login = async () => {
            try {
                await auth0Client.loginWithRedirect();
            } catch (e) {
                console.error("Erreur Login", e);
            }
        };

        // Fonction de déconnexion
        const logout = () => {
            try {
                auth0Client.logout({
                    logoutParams: {
                        returnTo: authConfig.redirectUri // Retourne à cette même page
                    }
                });
            } catch (e) {
                console.error("Erreur Logout", e);
            }
        };

    </script>
</body>
</html>
